{% extends 'base.html' %}
{% load static %}

{% block content %}
{% if messages %}
  <div id="toast-container" class="fixed top-5 right-5 z-50">
    {% for message in messages %}
      <div class="bg-green-100 border border-green-400 text-green-800 px-4 py-3 rounded shadow mb-2 animate-slide">
        <strong class="font-bold">Success!</strong>
        <span class="block sm:inline">{{ message }}</span>
      </div>
    {% endfor %}
  </div>

  <script>
    setTimeout(() => {
      document.getElementById('toast-container').remove();
    }, 4000); // Hide after 4 seconds
  </script>

  <style>
    @keyframes slide {
      0% { opacity: 0; transform: translateX(100%); }
      100% { opacity: 1; transform: translateX(0); }
    }
    .animate-slide {
      animation: slide 0.5s ease-out;
    }
  </style>
{% endif %}

<section class="section bg-gradient-to-b from-blue-50 to-white py-10">
  <div class="container mx-auto max-w-6xl">
    <h2 class="text-4xl font-bold text-primary mb-6 text-center">Leave Management</h2>
    <p class="text-gray-700 text-center mb-8">Track, apply for, and manage your leaves easily below.</p>

    <!-- Leave Application Form -->
    <form method="post" enctype="multipart/form-data" class="bg-white p-10 rounded-2xl shadow-md mb-10 border border-gray-200">
      {% csrf_token %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Leave Type -->
<div class="md:col-span-2">
  <label for="leave_type" class="block text-sm font-semibold text-gray-700 mb-1">Leave Type</label>
  <select name="leave_type" id="leave_type"
    class="w-full px-4 py-2 rounded-xl border border-blue-400 bg-blue-50 shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white"
    required>
    <option value="Casual">Casual</option>
    <option value="Sick">Sick</option>
    <option value="Vacation">Vacation</option>
    <option value="Emergency">Emergency</option>
  </select>
</div>

       <!-- Start Date -->
<div>
  <label for="start_date" class="block text-sm font-semibold text-gray-700 mb-1">Start Date</label>
  <input type="date" name="start_date" id="start_date"
    class="w-full px-4 py-2 rounded-xl border border-blue-400 bg-blue-50 shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white"
    required>
</div>

<!-- End Date -->
<div>
  <label for="end_date" class="block text-sm font-semibold text-gray-700 mb-1">End Date</label>
  <input type="date" name="end_date" id="end_date"
    class="w-full px-4 py-2 rounded-xl border border-blue-400 bg-blue-50 shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white"
    required>
</div>

<!-- Reason -->
<div class="md:col-span-2">
  <label for="reason" class="block text-sm font-semibold text-gray-700 mb-1">Reason</label>
  <input type="text" name="reason" id="reason"
    placeholder="Sick, Vacation..." required
    class="w-full px-4 py-2 rounded-xl border border-blue-400 bg-blue-50 shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white">
</div>

      <div class="text-center">
        <button type="submit" class="mt-6 px-8 py-3 bg-blue-600 text-white font-semibold rounded-xl shadow hover:bg-blue-700">Apply Leave</button>
      </div>
    </form>

    <script>
      const form = document.querySelector('form');
      form.addEventListener('submit', function(e) {
        const start = new Date(document.getElementById('start_date').value);
        const end = new Date(document.getElementById('end_date').value);

        if (start > end) {
          e.preventDefault();
          alert("‚ùå Start date cannot be after end date!");
        }
      });
    </script>

    <!-- Leave History Table -->
    <h3 class="text-2xl font-semibold mt-12 mb-4 text-center">My Leave Applications</h3>
    <div class="overflow-x-auto rounded-xl shadow border border-gray-200">
      <table class="min-w-full text-sm text-left">
        <thead class="bg-blue-100 text-blue-800 uppercase text-xs">
          <tr>
            <th class="px-6 py-3">From</th>
            <th class="px-6 py-3">To</th>
            <th class="px-6 py-3">Reason</th>
            <th class="px-6 py-3">Status</th>
            <th class="px-6 py-3">Action</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-100">
          {% for leave in leave_list %}
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">{{ leave.start_date }}</td>
            <td class="px-6 py-4">{{ leave.end_date }}</td>
            <td class="px-6 py-4">{{ leave.reason }}</td>
            <td class="px-6 py-4 font-medium {% if leave.status == 'Pending' %}text-yellow-600{% else %}text-green-600{% endif %}">{{ leave.status }}</td>
            <td class="px-6 py-4">
              {% if leave.status == 'Pending' %}
                <a href="{% url 'cancel-leave' leave.id %}" class="text-red-600 hover:underline">Cancel</a>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No leave records found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Leave Calendar -->
    <h3 class="text-2xl font-semibold mt-14 mb-4 text-center">Leave Calendar</h3>
    <div id="calendar" class="bg-white p-4 shadow rounded-xl border border-gray-200"></div>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          height: 500,
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
          },
          events: [
            {% for leave in leave_list %}
            {
              title: '{{ leave.reason }}',
              start: '{{ leave.start_date }}',
              end: '{{ leave.end_date|date:"Y-m-d" }}',
              color: '{% if leave.status == "Pending" %}#facc15{% else %}#34d399{% endif %}'
            },
            {% endfor %}
          ]
        });
        calendar.render();
      });
    </script>

    <!-- Min constraint for End Date -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const startInput = document.querySelector('#start_date');
        const endInput = document.querySelector('#end_date');

        startInput.addEventListener('change', function () {
          endInput.min = this.value;
        });
      });
    </script>
  </div>
</section>
{% endblock %}
